language: rust
rust:
  - stable
services:
  - docker
before_install:
  - docker pull clux/muslrust
script:
  - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo test --release
  - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust rustup component add clippy && cargo clippy
  - docker run -v cargo-cache:/root/.cargo/registry -v $PWD:/volume --rm -t clux/muslrust cargo build --release
deploy:
# Be sure to add a GITHUB_TOKEN environment variable in this job's config
# which the "Public Repos" permission, to enable pushing releases.
  - provider: releases
    file:
      - "target/x86_64-unknown-linux-musl/release/zerotect"
      - "reference/schema.json"
      - "reference/zerotect.toml"
      - "install/install.sh"
    skip_cleanup: true
    on:
      tags: true
    edge: true
  - provider: script
    script: bash scripts/docker-deploy.sh $TRAVIS_TAG
    skip_cleanup: true
    on:
      tags: true
